{% extends "base.html" %}
{% block title %}MBTI 테스트 진행 중{% endblock %}
{% block content %}
<div class="test-container">
    <div class="progress-bar">
        <div class="progress" id="progressBar"></div>
    </div>
    
    <div class="question-container" id="questionContainer">
        <div class="question-number" id="questionNumber">질문 1 / 4</div>
        <div class="question" id="questionText"></div>
        <div class="options" id="optionsContainer"></div>
        <button class="btn" id="nextBtn" onclick="nextQuestion()" disabled>다음</button>
    </div>
    
    <div class="result-container" id="resultContainer" style="display: none;">
        <div class="result-emoji" id="resultEmoji">🧠</div>
        <div class="mbti-result" id="mbtiResult">ENFP</div>
        <div class="result-title" id="resultTitle">재기발랄한 활동가</div>
        <div class="result-image-container">
            <img id="resultImage" src="" alt="MBTI 결과 이미지" style="display: none;">
        </div>
        <div class="result-description" id="resultDescription">
            당신은 열정적이고 창의적인 성격의 소유자입니다!
        </div>
        <div class="result-actions">
            <a href="/" class="btn">다시 테스트하기</a>
            <button class="btn btn-secondary" onclick="shareResult()">결과 공유하기</button>
        </div>
    </div>
</div>

<script>
const questions = {{ questions | tojsonfilter }};
let currentQuestion = 0;
let answers = [];

function showQuestion() {
    if (currentQuestion >= questions.length) {
        submitTest();
        return;
    }
    
    const question = questions[currentQuestion];
    document.getElementById('questionNumber').textContent = `질문 ${currentQuestion + 1} / ${questions.length}`;
    document.getElementById('questionText').textContent = question.question;
    
    const optionsContainer = document.getElementById('optionsContainer');
    optionsContainer.innerHTML = '';
    
    question.options.forEach((option, index) => {
        const optionElement = document.createElement('div');
        optionElement.className = 'option';
        optionElement.textContent = option.text;
        optionElement.onclick = () => selectOption(option.type, optionElement);
        optionsContainer.appendChild(optionElement);
    });
    
    const progress = (currentQuestion / questions.length) * 100;
    document.getElementById('progressBar').style.width = progress + '%';
    
    document.getElementById('nextBtn').disabled = true;
}

function selectOption(type, element) {
    document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
    element.classList.add('selected');
    
    answers[currentQuestion] = type;
    document.getElementById('nextBtn').disabled = false;
}

function nextQuestion() {
    currentQuestion++;
    showQuestion();
}

function submitTest() {
    document.getElementById('progressBar').style.width = '100%';
    
    fetch('/submit_test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({answers: answers})
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('오류가 발생했습니다: ' + data.error);
            return;
        }
        
        setTimeout(() => {
            document.getElementById('questionContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';
            
            document.getElementById('resultEmoji').textContent = data.emoji;
            document.getElementById('mbtiResult').textContent = data.mbti;
            document.getElementById('resultTitle').textContent = data.title;
            document.getElementById('resultDescription').textContent = data.description;
            
            // 이미지가 있으면 표시
            if (data.image) {
                const imgElement = document.getElementById('resultImage');
                imgElement.src = `/static/images/${data.image}`;
                imgElement.style.display = 'block';
            }
        }, 500);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('테스트 결과를 가져오는 중 오류가 발생했습니다.');
    });
}

function shareResult() {
    const mbti = document.getElementById('mbtiResult').textContent;
    const title = document.getElementById('resultTitle').textContent;
    const text = `나의 MBTI 결과는 ${mbti} (${title}) 입니다! 여러분도 테스트해보세요!`;
    
    if (navigator.share) {
        navigator.share({
            title: 'MBTI 테스트 결과',
            text: text,
            url: window.location.origin
        });
    } else {
        navigator.clipboard.writeText(text + ' ' + window.location.origin)
            .then(() => alert('결과가 클립보드에 복사되었습니다!'))
            .catch(() => alert('공유 기능을 사용할 수 없습니다.'));
    }
}

// 페이지 로드 시 첫 번째 질문 표시
document.addEventListener('DOMContentLoaded', showQuestion);
</script>
{% endblock %}